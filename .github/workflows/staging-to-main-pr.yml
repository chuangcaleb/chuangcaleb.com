name: Create Staging to Main PR

on:
  push:
    branches:
      - staging

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        run: |
          # Check if there's already an open PR from staging to main
          PR_COUNT=$(gh pr list --base main --head staging --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get commit messages since last sync
        id: commits
        if: steps.check-pr.outputs.pr_count == '0'
        run: |
          # Get commits that are in staging but not in main
          COMMITS=$(git log origin/main..origin/staging --pretty=format:"- %s (%h)" --no-merges | head -20)
          
          # If there are more than 20 commits, add a note
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/staging)
          if [ "$COMMIT_COUNT" -gt 20 ]; then
            COMMITS="$COMMITS"$'\n'"... and $((COMMIT_COUNT - 20)) more commits"
          fi
          
          # Escape for GitHub output
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_count == '0'
        run: |
          gh pr create \
            --base main \
            --head staging \
            --title "ðŸš€ Deploy updates from staging to main" \
            --body "## Staging to Main Deployment

          This PR contains ${{ steps.commits.outputs.commit_count }} update(s) from the \`staging\` branch, ready for deployment to \`main\`.

          ### Recent Changes
          ${{ steps.commits.outputs.commits }}

          ### Review Process
          - [ ] Review all dependency updates and changes
          - [ ] Verify CI checks pass
          - [ ] Check for any breaking changes or major updates
          - [ ] Ensure all changes are production-ready
          
          ### Merging
          This PR should be manually reviewed and merged when ready to deploy to production.
          After merging, \`main\` will be in sync with \`staging\`.
          
          ---
          *This PR was automatically created by the staging-to-main workflow.*"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update existing PR
        if: steps.check-pr.outputs.pr_count != '0'
        run: |
          # Update the existing PR with a comment about new changes
          PR_NUMBER=$(gh pr list --base main --head staging --state open --json number --jq '.[0].number')
          
          COMMITS=$(git log origin/main..origin/staging --pretty=format:"- %s (%h)" --no-merges | head -10)
          COMMIT_COUNT=$(git rev-list --count origin/main..origin/staging)
          
          gh pr comment "$PR_NUMBER" --body "ðŸ”„ **New updates pushed to staging**
          
          The staging branch has been updated with new changes.
          
          **Recent commits (showing latest 10 of $COMMIT_COUNT total):**
          $COMMITS
          
          Please review the updated changes before merging."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
